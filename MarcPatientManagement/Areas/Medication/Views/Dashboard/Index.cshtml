@model IEnumerable<EL.MedicationEntity>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Dashboard";

    var totalPatients = Model?.Select(m => m.Patient).Distinct().Count() ?? 0;
    var totalDrugs = Model?.Select(m => m.Drug).Distinct().Count() ?? 0;
    var totalPrescriptions = Model?.Count() ?? 0;

    var medications = Model ?? new List<EL.MedicationEntity>();

    var patientData = medications
        .GroupBy(m => m.Patient)
        .Select(g => new { Name = g.Key, Count = g.Count() })
        .OrderByDescending(g => g.Count)
        .ToList();

    var drugData = medications
        .GroupBy(m => m.Drug)
        .Select(g => new { Name = g.Key, Count = g.Count() })
        .OrderByDescending(g => g.Count)
        .ToList();
}


<h2 class="mb-4">Dashboard</h2>

<div class="row mb-4">
    <!-- Patients Card -->
    <div class="col-md-4 mb-3">
        <div class="card h-100" style="background-color:#e3f2fd; min-height:150px; ">
            <div class="card-body d-flex align-items-center">
                <i class="fas fa-user-injured fa-3x text-primary me-3"></i>
                <div>
                    <h6 class="card-title text-muted">Total Patients</h6>
                    <h3 class="card-text fw-bold">@totalPatients</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Drugs Card -->
    <div class="col-md-4 mb-3">
        <div class="card h-100" style="background-color:#e8f5e9;">
            <div class="card-body d-flex align-items-center">
                <i class="fas fa-pills fa-3x text-success me-3"></i>
                <div>
                    <h6 class="card-title text-muted">Total Drugs</h6>
                    <h3 class="card-text fw-bold">@totalDrugs</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Prescriptions Card -->
    <div class="col-md-4 mb-3">
        <div class="card h-100" style="background-color:#fff3e0;">
            <div class="card-body d-flex align-items-center">
                <i class="fas fa-file-medical fa-3x text-warning me-3"></i>
                <div>
                    <h6 class="card-title text-muted">Total Prescriptions</h6>
                    <h3 class="card-text fw-bold">@totalPrescriptions</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light fw-bold">Drug Prescriptions</div>
            <div class="card-body">
                <canvas id="drugLineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light fw-bold">Patient Prescriptions</div>
            <div class="card-body">
                <canvas id="patientBarChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        window.sortedDrugData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
            drugData.OrderBy(d => d.Count).Select(d => new { d.Name, d.Count })
        ));

        window.patientLabels = [@Html.Raw(string.Join(", ", patientData.Select(p => $"'{p.Name.Replace("'", "\\'")}'")))];
        window.patientCounts = [@string.Join(", ", patientData.Select(p => p.Count))];
    </script>

    <script src="~/Scripts/Page/Dashboard/Dashboard.js"></script>
}


